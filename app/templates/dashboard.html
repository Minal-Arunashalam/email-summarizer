{% extends "base.html" %}

{% block title %}Dashboard - Email Summarizer{% endblock %}

{% block content %}
<div class="dashboard">
    <h2>Summarize Emails</h2>
    <p>Enter a sender's email address to get individual summaries for each email.</p>

    <form id="summarize-form" class="summarize-form">
        <div class="form-group">
            <label for="sender_email">Sender Email Address</label>
            <input
                type="email"
                id="sender_email"
                name="sender_email"
                placeholder="example@company.com"
                required
            >
            <small>Enter the email address of the sender whose emails you want to summarize</small>
        </div>

        <div class="form-group">
            <label for="num_lines">Lines per Email Summary</label>
            <select id="num_lines" name="num_lines" required>
                <option value="1">1 line - One sentence each</option>
                <option value="2" selected>2 lines - Brief summary</option>
                <option value="3">3 lines - Standard summary</option>
                <option value="5">5 lines - Detailed summary</option>
            </select>
            <small>Number of summary lines for each individual email</small>
        </div>

        <div class="form-group">
            <label for="max_emails">Number of Emails to Summarize</label>
            <select id="max_emails" name="max_emails">
                <option value="10">10 emails</option>
                <option value="25">25 emails</option>
                <option value="50">50 emails</option>
                <option value="100">100 emails</option>
            </select>
            <small>Each email will receive its own individual summary</small>
        </div>

        <button type="submit" class="btn btn-primary" id="submit-btn">
            <span class="btn-text">Generate Summaries</span>
            <span class="btn-loading" style="display: none;">
                <span class="spinner"></span>
                Summarizing emails...
            </span>
        </button>
    </form>

    <div id="error-message" class="error-message" style="display: none;"></div>

    <div id="results" class="results" style="display: none;">
        <h3>Email Summaries</h3>
        <div class="summary-meta">
            <span id="result-sender"></span>
            <span id="result-count"></span>
        </div>
        <div id="summary-content" class="email-summaries"></div>
        <button type="button" class="btn btn-secondary" onclick="resetForm()">
            Summarize Another Sender
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const form = document.getElementById('summarize-form');
    const submitBtn = document.getElementById('submit-btn');
    const btnText = submitBtn.querySelector('.btn-text');
    const btnLoading = submitBtn.querySelector('.btn-loading');
    const errorMessage = document.getElementById('error-message');
    const results = document.getElementById('results');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        // Show loading state
        btnText.style.display = 'none';
        btnLoading.style.display = 'inline-flex';
        submitBtn.disabled = true;
        errorMessage.style.display = 'none';
        results.style.display = 'none';

        const formData = {
            sender_email: document.getElementById('sender_email').value,
            num_lines: parseInt(document.getElementById('num_lines').value),
            max_emails: parseInt(document.getElementById('max_emails').value)
        };

        try {
            const response = await fetch('/api/summarize', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.detail || 'An error occurred');
            }

            // Show results
            document.getElementById('result-sender').textContent = `From: ${formData.sender_email}`;
            document.getElementById('result-count').textContent = `${data.email_count} emails summarized`;
            document.getElementById('summary-content').innerHTML = formatSummaries(data.summaries);
            results.style.display = 'block';
            form.style.display = 'none';

        } catch (error) {
            errorMessage.textContent = error.message;
            errorMessage.style.display = 'block';
        } finally {
            // Reset button state
            btnText.style.display = 'inline';
            btnLoading.style.display = 'none';
            submitBtn.disabled = false;
        }
    });

    function formatSummaries(summaries) {
        return summaries.map((email, index) => {
            const summaryLines = email.summary
                .split('\n')
                .filter(line => line.trim())
                .map(line => `<p>${escapeHtml(line)}</p>`)
                .join('');

            return `
                <div class="email-card">
                    <div class="email-header">
                        <span class="email-number">#${index + 1}</span>
                        <h3 class="email-subject">${escapeHtml(email.subject)}</h3>
                        <span class="email-date">${escapeHtml(email.date)}</span>
                    </div>
                    <div class="email-summary">
                        ${summaryLines}
                    </div>
                </div>
            `;
        }).join('');
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function resetForm() {
        form.style.display = 'block';
        results.style.display = 'none';
        form.reset();
    }
</script>
{% endblock %}
